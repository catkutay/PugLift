# Load testing using gatling

## What we use it for

We use [Gatling](https://gatling.io) to test the server's performance. It lets us program test scenarios that simulate user requests. In our case, we wanted to simulate the sending of event data to our server, so we set it up such that *each* user would send data for the following set of events:

+ page load
+ bid request
+ bid response
+ ad request
+ ad response
+ creative render

> **NOTE**
> Make sure the names of the event type match the names specified in the app. We followed the client's naming convention for the events.

We chose Gatling because we were exploring WebSockets for our app, and Gatling supports WebSockets. We were not able to get WebSockets to work, however, and have defaulted back to http. Future testing can therefore be done using other load testing software, unless the team wishes to explore WebSockets too. See the *Issues* section below for the issues we faced while working with Gatling.

### Data source

The client had supplied a demo webpage, which, when loaded, would `console.log` real data for the *ad request* and *ad response* events (not available if ad blockers are on). These are extracted into .json files and incorporated into the test, while the rest of the events used simple dummy data. The real data consists of a separate JSON object for each ad slot on a webpage. To simulate the behaviour of the demo webpage in Gatling, the *ad request* event sends all the data in one array, while the *ad response* event sends it one at a time.

As a side note, the dataset generated by the demo webpage actually has a circular structure - the objects have keys that are self-referencing and this prevents them from being extracted. We first saved the object as a global variable (right-click context menu), used the loop in the answer of [this stackoverflow question](https://stackoverflow.com/questions/11616630/json-stringify-avoid-typeerror-converting-circular-structure-to-json) to remove those self-referencing keys, then copied the data into a .json file for use in a feeder (see *Feeders* section below).

### Graphs

Gatling automatically generates HTML reports with graphs for completed simulations. These can be found in the `puglift-gatling-test\results` folder. The graphs are interactive and respond to mouseovers. A separate HTML file is generated for each event.

## How to run it

> **NOTE**
> See *README.md* in the `puglift-gatling-test` repository for instructions on testing gatling against GCloud.

### On Windows machines

1. Ensure the app is running before proceeding with the test.
2. Open up a `cmd` window and `cd` into the `puglift-gatling-test` folder.
3. Type `.\bin\gatling.bat` and hit Enter to start.
4. When prompted to choose a *simulation number*, enter `0` for *publift.HttpStressSimulation*.
5. Hit Enter twice to skip the prompts for *simulation id* and *run description*.
6. Let the simulation run its course. A status report is logged on the window every 5 seconds. The simulation will terminate on its own after a set amount of time (see the *Varying users over time* section below), or use `Ctrl-C` to terminate it manually.

### On non-Windows machines

Exactly the same as on Windows except the run command is `./bin/gatling/sh`

## How to modify it

> **NOTE**
> The following sections will be referring to `puglift-gatling-test\user-files\simulations\publift\HttpStressSimulation.scala`.

### Changing the destination

The simulation can be pointed at the app running either in the cloud (line 13):

> `.baseURL("http://publift-sds-2017.appspot.com")`

or on localhost (line 14):

> `.baseURL("http://localhost:3000")`

Comment/uncomment the lines accordingly.

### Varying users over time

In order to vary the number of users (and therefore requests) and the length of the simulation, modify line 68:

> `setUp(scn.inject(rampUsersPerSec(10) to 50 during(60 seconds) randomized)).protocols(httpConf)`

The first number is the rate of increase of users, the second number is the maximum number of users and the third number the length of time that the simulation will run for.

### Feeders

Feeders in Gatling are the sources of data that are to be sent during the simulated user requests. See [the official documentation](https://gatling.io/docs/current/session/feeder/).

We currently have 3 feeders set up:

+ `feeder`: a UUID generator for user id
+ `adRequestFeed` and `adResponseFeed`: use the contents of the specified .json files

> **NOTE**
> Feeder files have to be placed in the `puglift-gatling-test\user-files\data` folder

## Issues

### Connection refused error on Windows localhost

This has to do with Gatling defaulting to IPv4 while Windows prefers IPv6. Ensure that the Java options in `puglift-gatling-test\bin\gatling.bat` on line 45 are set accordingly:

> `-Djava.net.preferIPv4Stack=false -Djava.net.preferIPv6Addresses=true`

### Gatling not escaping double quotes properly

The original dataset obtained from the client's demo webpage contains strings of HTML and JavaScript code with double quotes that Gatling fails to escape properly. This is a known issue - see [the discussion](https://github.com/gatling/gatling/issues/3296). A fix is planned for Gatling 3.0, due for release in December 2017 at this stage. Our workaround for now (Gatling 2.3) was to replace the whole string with lorem ipsum text of the same length.
